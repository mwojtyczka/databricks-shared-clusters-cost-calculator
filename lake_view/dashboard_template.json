{"datasets":[{"name":"afac4138","displayName":"cost_agg_day","query":"SELECT \n    u.organizational_entity_value as department,\n    c.billing_date,\n    COALESCE(dbu_cost, 0) + COALESCE(cloud_cost, 0) AS total_cost,\n    c.account_id,\n    c.warehouse_id,\n    c.workspace_id,\n    c.cloud,\n    c.user_name\nFROM {catalog_and_schema}.cost_agg_day AS c\nINNER JOIN {catalog_and_schema}.user_info AS u ON u.user_name = c.user_name\nWHERE u.organizational_entity_name = 'department'\n"},{"name":"0bb4e524","displayName":"budget","query":"\n\nWITH monthly_costs AS (\n    SELECT\n      ui.organizational_entity_value AS department,\n      cad.currency_code,\n      CAST(DATE_TRUNC('month', cad.billing_date) AS DATE) as month,\n      SUM(cad.dbu_cost) AS total_dbu_cost,\n      SUM(cad.cloud_cost) AS total_cloud_cost\n    FROM {catalog_and_schema}.cost_agg_day cad\n    INNER JOIN {catalog_and_schema}.user_info ui\n      ON ui.user_name = cad.user_name\n    WHERE\n      ui.organizational_entity_name = 'department'\n    GROUP BY\n      ui.organizational_entity_value,\n      cad.currency_code,\n      DATE_TRUNC('month', cad.billing_date)\n),\nbudget_info AS (\n    SELECT\n      organizational_entity_value AS department,\n      effective_start_date,\n      COALESCE(effective_end_date, CURRENT_DATE) AS effective_end_date,\n      dbu_cost_limit,\n      cloud_cost_limit,\n      currency_code\n    FROM {catalog_and_schema}.budget\n    WHERE\n      organizational_entity_name = 'department'\n), cost_report AS (\n    SELECT\n      mc.department,\n      mc.month,\n      mc.total_dbu_cost,\n      bi.dbu_cost_limit,\n      mc.total_cloud_cost,\n      bi.cloud_cost_limit,\n      CASE\n        WHEN mc.total_dbu_cost IS NULL OR bi.dbu_cost_limit IS NULL THEN NULL\n        WHEN mc.total_dbu_cost <= bi.dbu_cost_limit THEN false\n        ELSE true\n      END AS dbu_cost_over_budget,\n      CASE\n        WHEN mc.total_cloud_cost IS NULL OR bi.cloud_cost_limit IS NULL THEN NULL\n        WHEN mc.total_cloud_cost <= bi.cloud_cost_limit THEN false\n        ELSE true\n      END AS cloud_cost_over_budget\n    FROM monthly_costs mc\n    INNER JOIN budget_info bi\n      ON mc.department = bi.department\n        AND mc.currency_code = bi.currency_code\n        AND mc.month BETWEEN bi.effective_start_date AND bi.effective_end_date\n    ORDER BY\n      mc.department,\n      mc.month\n)\nSELECT *\nFROM cost_report"}],"pages":[{"name":"5339846d","displayName":"New Page","layout":[{"widget":{"name":"d76dfa6f","textbox_spec":"# Granular Cost Allocation for Shared Clusters\n\nThis dashboard allocates usage of “Shared” SQL Warehouses to individual users and their respective organisational entities (eg. cost center, business unit).   "},"position":{"x":0,"y":0,"width":6,"height":2}},{"widget":{"name":"87e12cc3","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"sum(total_cost)","expression":"SUM(`total_cost`)"},{"name":"monthly(billing_date)","expression":"DATE_TRUNC(\"MONTH\", `billing_date`)"},{"name":"department","expression":"`department`"},{"name":"user_name","expression":"`user_name`"}],"cubeGroupingSets":{"sets":[{"fieldNames":["department","user_name"]},{"fieldNames":["monthly(billing_date)"]}]},"disaggregated":false,"orders":[{"direction":"ASC","expression":"`department`"},{"direction":"ASC","expression":"`user_name`"},{"direction":"ASC","expression":"DATE_TRUNC(\"MONTH\", `billing_date`)"}]}}],"spec":{"version":3,"widgetType":"pivot","encodings":{"rows":[{"fieldName":"department","displayName":"Department"},{"fieldName":"user_name","displayName":"User"}],"columns":[{"fieldName":"monthly(billing_date)","displayName":"date"}],"cell":{"type":"multi-cell","fields":[{"fieldName":"sum(total_cost)","cellType":"text","displayName":"cost [$]"}]}},"frame":{"showTitle":true,"title":"Total cost breakdown over billing period"}}},"position":{"x":0,"y":10,"width":6,"height":4}},{"widget":{"name":"63082bcd","queries":[{"name":"dashboards/01ef4040f8591888ba15c3793a86b5b8/datasets/01ef4040f87918a3b1699d025028686c_department","query":{"datasetName":"afac4138","fields":[{"name":"department","expression":"`department`"},{"name":"department_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"department","displayName":"department","queryName":"dashboards/01ef4040f8591888ba15c3793a86b5b8/datasets/01ef4040f87918a3b1699d025028686c_department"}]},"frame":{"showTitle":true,"title":"Department"}}},"position":{"x":0,"y":2,"width":1,"height":2}},{"widget":{"name":"21c9a2b0","queries":[{"name":"dashboards/01ef3f76c825191d9c9a02e43d33a64e/datasets/01ef3f76c82a1107a553d0f8b2038744_user_name","query":{"datasetName":"afac4138","fields":[{"name":"user_name","expression":"`user_name`"},{"name":"user_name_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"user_name","displayName":"user_name","queryName":"dashboards/01ef3f76c825191d9c9a02e43d33a64e/datasets/01ef3f76c82a1107a553d0f8b2038744_user_name"}]},"frame":{"showTitle":true,"title":"User"}}},"position":{"x":1,"y":2,"width":1,"height":2}},{"widget":{"name":"e3aca167","queries":[{"name":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_billing_date","query":{"datasetName":"afac4138","fields":[{"name":"billing_date","expression":"`billing_date`"},{"name":"billing_date_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-date-range-picker","encodings":{"fields":[{"fieldName":"billing_date","displayName":"billing_date","queryName":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_billing_date"}]},"frame":{"showTitle":true,"title":"Date range"}}},"position":{"x":5,"y":2,"width":1,"height":2}},{"widget":{"name":"30123baa","queries":[{"name":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_cloud","query":{"datasetName":"afac4138","fields":[{"name":"cloud","expression":"`cloud`"},{"name":"cloud_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"cloud","displayName":"cloud","queryName":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_cloud"}]},"frame":{"showTitle":true,"title":"Cloud"}}},"position":{"x":2,"y":2,"width":1,"height":2}},{"widget":{"name":"365716a7","queries":[{"name":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_warehouse_id","query":{"datasetName":"afac4138","fields":[{"name":"warehouse_id","expression":"`warehouse_id`"},{"name":"warehouse_id_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"warehouse_id","displayName":"warehouse_id","queryName":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_warehouse_id"}]},"frame":{"showTitle":true,"title":"Warehouse (ID)"}}},"position":{"x":3,"y":2,"width":1,"height":2}},{"widget":{"name":"8455bfa2","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"user_name","expression":"`user_name`"},{"name":"monthly(billing_date)","expression":"DATE_TRUNC(\"MONTH\", `billing_date`)"},{"name":"sum(total_cost)","expression":"SUM(`total_cost`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"x":{"fieldName":"monthly(billing_date)","scale":{"type":"temporal"},"displayName":"date"},"y":{"fieldName":"sum(total_cost)","scale":{"type":"quantitative"},"displayName":"cost [$]"},"color":{"fieldName":"user_name","scale":{"type":"categorical"},"displayName":"User"},"label":{"show":true}},"frame":{"showTitle":true,"title":"Total monthly cost by user"}}},"position":{"x":2,"y":4,"width":2,"height":6}},{"widget":{"name":"816a105e","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"department","expression":"`department`"},{"name":"monthly(billing_date)","expression":"DATE_TRUNC(\"MONTH\", `billing_date`)"},{"name":"sum(total_cost)","expression":"SUM(`total_cost`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"x":{"fieldName":"monthly(billing_date)","scale":{"type":"temporal"},"displayName":"date"},"y":{"fieldName":"sum(total_cost)","scale":{"type":"quantitative"},"displayName":"cost [$]"},"color":{"fieldName":"department","scale":{"type":"categorical"},"displayName":"department"},"label":{"show":true}},"frame":{"showTitle":true,"title":"Total monthly cost by department"}}},"position":{"x":0,"y":4,"width":2,"height":6}},{"widget":{"name":"874af2f4","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"sum(total_cost)","expression":"SUM(`total_cost`)"},{"name":"cloud","expression":"`cloud`"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"pie","encodings":{"angle":{"fieldName":"sum(total_cost)","scale":{"type":"quantitative"},"displayName":"cost [$]"},"color":{"fieldName":"cloud","scale":{"type":"categorical"},"displayName":"cloud"},"label":{"show":true}},"frame":{"showTitle":true,"title":"Cloud distribution"}}},"position":{"x":4,"y":6,"width":2,"height":4}},{"widget":{"name":"dd9e3a86","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"sum(total_cost)","expression":"SUM(`total_cost`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"counter","encodings":{"value":{"fieldName":"sum(total_cost)","displayName":"Sum of total_cost"}},"frame":{"showTitle":true,"title":"Total cost"}}},"position":{"x":4,"y":4,"width":1,"height":2}},{"widget":{"name":"6d7fade9","queries":[{"name":"main_query","query":{"datasetName":"afac4138","fields":[{"name":"countdistinct(user_name)","expression":"COUNT(DISTINCT `user_name`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"counter","encodings":{"value":{"fieldName":"countdistinct(user_name)","displayName":"Count of Unique user_name"}},"frame":{"showTitle":true,"title":"Users"}}},"position":{"x":5,"y":4,"width":1,"height":2}},{"widget":{"name":"f7961378","queries":[{"name":"main_query","query":{"datasetName":"0bb4e524","fields":[{"name":"month","expression":"`month`"},{"name":"department","expression":"`department`"},{"name":"dbu_cost_over_budget","expression":"`dbu_cost_over_budget`"},{"name":"cloud_cost_over_budget","expression":"`cloud_cost_over_budget`"},{"name":"total_dbu_cost","expression":"`total_dbu_cost`"},{"name":"dbu_cost_limit","expression":"`dbu_cost_limit`"},{"name":"total_cloud_cost","expression":"`total_cloud_cost`"},{"name":"cloud_cost_limit","expression":"`cloud_cost_limit`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"month","dateTimeFormat":"YYYY-MM-DD","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"date","displayAs":"datetime","visible":true,"order":0,"title":"month","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"month"},{"fieldName":"department","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":1,"title":"department","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"department"},{"fieldName":"dbu_cost_over_budget","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"boolean","displayAs":"boolean","visible":true,"order":2,"title":"dbu_cost_over_budget","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"dbu_cost_over_budget"},{"fieldName":"cloud_cost_over_budget","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"boolean","displayAs":"boolean","visible":true,"order":3,"title":"cloud_cost_over_budget","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"cloud_cost_over_budget"},{"fieldName":"total_dbu_cost","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":4,"title":"total_dbu_cost","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"total_dbu_cost"},{"fieldName":"dbu_cost_limit","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":5,"title":"dbu_cost_limit","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"dbu_cost_limit"},{"fieldName":"total_cloud_cost","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":6,"title":"total_cloud_cost","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"total_cloud_cost"},{"fieldName":"cloud_cost_limit","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":7,"title":"cloud_cost_limit","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"cloud_cost_limit"}]},"invisibleColumns":[],"allowHTMLByDefault":false,"itemsPerPage":25,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"title":"Total monthly budget breakdown","showTitle":true,"showDescription":false}}},"position":{"x":0,"y":14,"width":6,"height":6}},{"widget":{"name":"2d37747b","queries":[{"name":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_warehouse_id","query":{"datasetName":"afac4138","fields":[{"name":"warehouse_id","expression":"`warehouse_id`"},{"name":"warehouse_id_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}},{"name":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_account_id","query":{"datasetName":"afac4138","fields":[{"name":"account_id","expression":"`account_id`"},{"name":"account_id_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"warehouse_id","displayName":"warehouse_id","queryName":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_warehouse_id"},{"fieldName":"account_id","displayName":"account_id","queryName":"dashboards/01ef4aa67c4e1932a6b0d13b9c50002b/datasets/01ef4aa67c551c7085981003578e07ed_account_id"}]},"frame":{"showTitle":true,"title":"Account (ID)"}}},"position":{"x":4,"y":2,"width":1,"height":2}}]}]}